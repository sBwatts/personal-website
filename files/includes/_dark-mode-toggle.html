<!-- Dark Mode Toggle -->
<style>
  /* Theme toggle button styling */
  .theme-toggle {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #1e293b;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.1rem;
  }

  .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
  }

  [data-theme="dark"] .theme-toggle {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #e2e8f0;
  }

  [data-theme="dark"] .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .theme-toggle .theme-icon {
    width: 20px;
    height: 20px;
    transition: transform 0.3s ease;
  }

  .theme-toggle:hover .theme-icon {
    transform: rotate(20deg);
  }

  /* Hide appropriate icon based on theme */
  [data-theme="light"] .theme-icon-moon {
    display: inline-block;
  }

  [data-theme="light"] .theme-icon-sun {
    display: none;
  }

  [data-theme="dark"] .theme-icon-moon {
    display: none;
  }

  [data-theme="dark"] .theme-icon-sun {
    display: inline-block;
  }
</style>

<script>
  // CRITICAL: This script must run BEFORE page render to prevent flash
  (function() {
    // Function to get initial theme
    function getInitialTheme() {
      // Check localStorage first
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        return savedTheme;
      }

      // Check system preference
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }

      // Default to light
      return 'light';
    }

    // Function to apply theme
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      // Update body class for Quarto compatibility
      if (theme === 'dark') {
        document.body.classList.remove('quarto-light');
        document.body.classList.add('quarto-dark');
      } else {
        document.body.classList.remove('quarto-dark');
        document.body.classList.add('quarto-light');
      }
    }

    // Apply initial theme immediately
    const initialTheme = getInitialTheme();
    applyTheme(initialTheme);

    // Function to toggle theme
    window.toggleTheme = function() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
    };

    // Listen for system theme changes
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        // Only auto-switch if user hasn't manually set a preference
        if (!localStorage.getItem('theme')) {
          applyTheme(e.matches ? 'dark' : 'light');
        }
      });
    }

    // Function to add toggle button
    function addToggleButton() {
      const navbarTools = document.querySelector('.quarto-navbar-tools');
      if (navbarTools) {
        const toggleButton = document.createElement('button');
        toggleButton.className = 'theme-toggle';
        toggleButton.setAttribute('aria-label', 'Toggle dark mode');
        toggleButton.onclick = toggleTheme;
        toggleButton.innerHTML = `
          <i class="bi bi-moon-stars-fill theme-icon theme-icon-moon"></i>
          <i class="bi bi-sun-fill theme-icon theme-icon-sun"></i>
        `;
        navbarTools.appendChild(toggleButton);
      }
    }

    // Add toggle button - handle both cases (DOM ready or not)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', addToggleButton);
    } else {
      // DOM is already ready, add button immediately
      addToggleButton();
    }
  })();
</script>
